%%
%% copyright quintard julien
%% 
%% kaneton
%% 
%% arch-mips.tex
%% 
%% path          /home/mycure/kaneton/view/lectures
%% 
%% made by mycure
%%         quintard julien   [quinta_j@epita.fr]
%% 
%% started on    Tue Jul  5 12:23:08 2005   mycure
%% last update   Sat Nov 19 12:48:45 2005   mycure
%%

%
% template
%

\input{../../templates/lecture.tex}

%
% title
%

\title{MIPS Architectures}

%
% authors
%

\author
{
  Julien~Quintard\inst{1}
}

%
% figures
%

\pgfdeclareimage[interpolate=true,width=166pt,height=26pt]
                {r-format}
		{figures/r-format}
\pgfdeclareimage[interpolate=true,width=166pt,height=26pt]
                {i-format}
		{figures/i-format}
\pgfdeclareimage[interpolate=true,width=166pt,height=26pt]
                {j-format}
		{figures/j-format}

\pgfdeclareimage[interpolate=true,width=166pt,height=46pt]
                {overflow-handling}
		{figures/overflow-handling}
\pgfdeclareimage[interpolate=true,width=166pt,height=46pt]
                {overflow-avoiding}
		{figures/overflow-avoiding}

%
% document
%

\begin{document}

%
% title frame
%

\begin{frame}
  \titlepage

  \begin{center}
    \logos
  \end{center}
\end{frame}

%
% outline frame
%

\begin{frame}
  \frametitle{Outline}
  \tableofcontents
\end{frame}

%
% introduction
%

\section{Introduction}

% 1)

\begin{frame}
  \frametitle{Description}

  \begin{itemize}[<+->]
    \item
      About \textbf{thirty} course hours.
    \item
      Concluded by an exam.
  \end{itemize}
\end{frame}

% 2)

\begin{frame}
  \frametitle{Contents}

  \begin{itemize}[<+->]
    \item
      External architecture.
    \item
      Pipeline.
    \item
      Compiler optimisations.
    \item
      Memory.
  \end{itemize}
\end{frame}

%
% overview
%

\section{Overview}

% 1)

\begin{frame}
  \frametitle{Introduction}

  An architecture is composed of:

  \begin{itemize}[<+->]
    \item
      Visible registers.
    \item
      Instructions set.
    \item
      Addressing.
    \item
      Interrupts/exceptions system.
  \end{itemize}
\end{frame}

% 2)

\begin{frame}
  \frametitle{Description}

  The MIPS processor is a 32-bit little-endian processor.

  \nl

  This processor provides \textbf{32 integer registers}, from R0 to R31.

  \nl

  Nevertheless two registers have special meaning:

  \begin{itemize}[<+->]
    \item
      \textbf{R0}: Trash Register: this register when read returns zero and
      writtings are ignored.
    \item
      \textbf{R31}: Link Register: this register holds the return address
      of a subprogram.
  \end{itemize}
\end{frame}

% 3)

\begin{frame}
  \frametitle{Special Registers}

  There are other special registers:

  \begin{itemize}[<+->]
    \item
      \textbf{HI and LO} are used for multiplications and division.
  \end{itemize}

  The MIPS precessor has four registers very interesting for system
  programming:

  \begin{itemize}[<+->]
    \item
      \textbf{SR}: Status Register: used to distinguish the two context
      modes: user and supervisor.
    \item
      \textbf{CAUSE}: holds the cause of the interrupt/exception.
    \item
      \textbf{EPC}: Exception Program Counter: holds the program counter
      of the instruction that caused the exception.
    \item
      \textbf{BAR}: Bad Address Register: holds the address that cause
      the memory error.
  \end{itemize}
\end{frame}

%
% instruction formats
%

\section{Instruction Formats}

% 1)

\begin{frame}
  \frametitle{Overview}

  The MIPS processor classifies its 57 instructions into three groups.

  \begin{enumerate}[<+->]
    \item
      \textbf{R}: Register to register instructions: Register-Type.
    \item
      \textbf{I}: Memory and Branch instructions: Immediate-Type.
    \item
      \textbf{J}: Jump instructions: Jump-Type
  \end{enumerate}

  Note that a branch instruction is a conditional jump while a jump
  instruction is an uncontional jump.
\end{frame}

% 2)

\begin{frame}
  \frametitle{Register Format}

  \begin{center}
    \pgfuseimage{r-format}
  \end{center}

  \begin{itemize}[<+->]
    \item
      \textbf{OPCODE}: the operation code.
    \item
      \textbf{RS}: the source register.
    \item
      \textbf{RT}: the alternative register: source/destination.
    \item
      \textbf{RD}: the destination register.
    \item
      \textbf{SHAM}: \textbf{SH}ift \textbf{AM}ount: used by
      shift instructions.
    \item
      \textbf{FUNC}: this function field is used to extend the number
      of available opcodes. Remember that opcode is an expensive resource.
  \end{itemize}
\end{frame}

% 3)

\begin{frame}[containsverbatim]
  \frametitle{Examples}

  Let's see some examples of register to register instructions.

  \begin{itemize}[<+->]
    \item
      Add Rd, Rs, Rt
    \item
      Addu Rd, Rs, Rt
    \item
      Sllv Rd, Rt, Rs
    \item
      Srl Rd, Rt, sham
  \end{itemize}
\end{frame}

% 4)

\begin{frame}
  \frametitle{Immediate Format}

  \begin{center}
    \pgfuseimage{i-format}
  \end{center}

  \begin{itemize}[<+->]
    \item
      \textbf{OPCODE}: the operation code.
    \item
      \textbf{RS}: the source register.
    \item
      \textbf{RT}: the alternative register: source/destination.
    \item
      \textbf{IMMED}: an immediate value.
  \end{itemize}
\end{frame}

% 5)

\begin{frame}[containsverbatim]
  \frametitle{Examples}

  Let's see some examples of immediate instructions.

  \begin{itemize}[<+->]
    \item
      Addi Rd, Rs, Immed
    \item
      Addiu Rd, Rs, Immed
    \item
      Andi Rd, Rs, Immed
    \item
      Ori Rd, Rs, Immed
  \end{itemize}
\end{frame}

% 6)

\begin{frame}
  \frametitle{Jump Format}

  \begin{center}
    \pgfuseimage{j-format}
  \end{center}

  \begin{itemize}[<+->]
    \item
      \textbf{OPCODE}: the operation code.
    \item
      \textbf{IMMED}: immediate value.
  \end{itemize}
\end{frame}

% 7)

\begin{frame}[containsverbatim]
  \frametitle{Examples}

  Let's see some examples of jump instructions.

  \begin{itemize}[<+->]
    \item
      J Immed
  \end{itemize}
\end{frame}

% 8)

\begin{frame}[containsverbatim]
  \frametitle{Opcodes}

  We saw that the opcode field took 6 bits.

  \nl

  We also saw that the register-type instructions had a function field
  to extend the number of opcodes. So a value for the opcode field is
  dedicated to the use of the function extended field.

  \nl

  This specific opcode value is zerp: \textbf{000 000}

  \nl

  So the number of opcode available on the MIPS is:

  \begin{verbatim}
    opcodes =   opcode field - 1   +   function field
            =    (2 ^ 6) - 1       +     (2 ^ 6)
            =        63            +       64

            =   127
  \end{verbatim}
\end{frame}

% 9)

\begin{frame}
  \frametitle{Questions}

  Any question?

  \begin{itemize}[<+->]
    \item
      Why the \textbf{Subi} instruction does not exist?
    \item
      Why the \textbf{Jr} instruction is a register-type instruction
      while its goal is to perform a jump?
    \item
      Why the \textbf{Nori} instruction does not exist?
    \item
      Why the \textbf{Sll} instruction is a register-type instruction
      while it uses an immediate?
  \end{itemize}

  The answers are:

  \begin{itemize}[<+->]
    \item
      Opcode is a very expensive resource.
    \item
      Most instructions are useless because the designed operation can be
      made with another instruction.
    \item
      \textbf{MIXs} are used to design the instruction set with these
      two rules.
  \end{itemize}
\end{frame}

%
% instructions
%

\section{Instructions}

% 1)

\begin{frame}
  \frametitle{Arithmetic and Logic instructions}

  We will see how the processor interprets different instructions.

  \nl

  The processor also divides the instructions into two subcategories:
  the arithmetic instructions and the logic instructions.

  \nl

  Briefly, the arithmetic instructions handles overflow while logic
  one do not.
\end{frame}

% 2)

\begin{frame}
  \frametitle{Overflow Avoiding}

  Let's take the \textbf{Andi Rt, Rs, Immed} immediate-type
  instruction as example.

  \nl

  Not that overflow is ignored with logic instructions and with
  specific unsigned instructions (\textbf{u} suffixed) like:
  Addiu, Srl, Subu etc..

  \nl

  So in the case of the \textbf{Andi} instruction which is a logic instruction,
  the immediate will be interpreted as an unsigned value.

  \nl

  The 16-bit immediate value will be expanded to a 32-bit one just
  filling the 16 higher bits with zeros.

  \nl

  \begin{center}
    \pgfuseimage{overflow-avoiding}
  \end{center}
\end{frame}

% 3)

\begin{frame}
  \frametitle{Overflow Handling}

  Let's take the \textbf{Addi Rt, Rs, Immed} immediate-type
  instruction as an example of a arithmetic one.

  \nl

  The non-presence of the \textbf{u} suffix introduces the overflow
  handling. This means that the immediate value will be considered
  as a signed value.

  \nl

  So, the signed value will be expanded as a 32-bit value taking care
  to report the sign bit.

  \nl

  \begin{center}
    \pgfuseimage{overflow-handling}
  \end{center}
\end{frame}

% 4)

\begin{frame}[containsverbatim]
  \frametitle{Immediate Limitations}

  Let's see a common problem due to the immediate field limitations.

  \nl

  How to move the 32-bit value \textbf{0x87654321} into the R1 register.

  \begin{verbatim}
    Addi R1, R0, 0x8765
    Sll R1, R1, 16
    Addi R1, R1, 0x4321
  \end{verbatim}

  This operation being very useful, the designers of the MIPS processor
  decided to add a new instruction named \textbf{Lui} which do
  exactly the:

  \begin{itemize}
    \item
      Add Rn, R0, Immed
      Sll Rn, Rn, 16
  \end{itemize}
\end{frame}

% 5)

\begin{frame}
  \frametitle{Another Problem}

  Let's take a closer look to the sequence of these three instructions:

  \begin{verbatim}
    Addi R1, R0, 0x4567
    Sll R1, R1, 16
    Addi R1, R1, 0x89ab
  \end{verbatim}

  This sequence seems correct but it is not. Remember that the arithmetic
  operations handle the overflow. In other terms, the operands of
  arithmetic operations are considered as signed integers.

  \nl

  The value \textbf{0x89ab} is equivalent to the binary value:
  \textbf{1000100110101011}.

  \nl

  You can notive that the higher bit is set so this number will be considered
  as a signed integer.

  \nl

  The solution is simply to prefere a logic operation:

  \begin{verbatim}
    Addi R1, R0, 0x4567
    Sll R1, R1, 16
    Ori R1, R1, 0x89ab
  \end{verbatim}
\end{frame}

%
% bibliography
%

\section{Bibliography}

\begin{thebibliography}{3}

  \bibitem{Howto}
    GNU C Preprocessor Howto

  \bibitem{Queue}
    Queue.h
    \newblock /usr/include/sys/queue.h
    \newblock A linked-list manager using macros
\end{thebibliography}

\end{document}
