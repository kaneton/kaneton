\section*{Exercice 4 : Pagination (6 points)}

Nous souhaitons développer un système de gestion de la mémoire
virtuelle pour ChicheOS sur l'architecture Intel. Trois mots décrivent
la philosophie de ChicheOS : ``maintenir, réparer et prévoir''. En
conséquence, ChicheOS évite avec prudence la périlleuse technique du
\textit{mirroring}.

Le noyau ChicheOS doit pouvoir accéder \`a n'importe quelle adresse
physique par le biais de traductions d'adresses temporaires, tout en
optimisant l'utilisation du TLB \footnote{\emph{Rappel:} Translation
  Lookaside Buffer : cache de traduction d'adresse}.

Afin de permettre la mise en place de traductions temporaires,
ChicheOS rend accessible une table de page particulière depuis
l'espace d'adressage du noyau. Cette table de page particulière est
nommée CPT \footnote{Chiche Page Table}. \textup{La CPT est utilisée
  comme un \textbf{cache} de traduction d'adresses}.

\begin{itemize}
\item La CPT se situe en mémoire physique \`a l'adresse physique
  \verb+0x100b000+.
\item La CPT est accessible dans l'espace d'adressage du
  noyau \`a l'adresse \verb+0xC0000000+.
\item L'entrée numéro \verb+0x380+
  du Page Directory du noyau contient l'adresse physique de la CPT.
\end{itemize}

\subsection*{API ChicheOS}
\begin{itemize}
\item \verb+int rand_1024()+ : Renvoie un nombre aléatoire
  entre 0 et 1023 inclus.
\item \verb+void pt_entry(int entry, vaddr_t pt, paddr_t page)+ : Ajoute
  une entrée dans une Page Table \`a l'index \verb+entry+ et ajuste les
  paramètres de l'entrée de manière \`a créer une
  translation d'adresse privilégiée valide pour le noyau.
\item \verb+char get_entry_data(int entry, vaddr_t pt)+ : Retourne les 3
  bits du champ AVL d'une entrée de Page Table. Les spécifications Intel
  documentent ces 3 bits comme ``Available for programmer use''.
\item \verb+void set_entry_data(int entry, vaddr_t pt, char data)+ :
  Ecris les 3 bits du champs AVL d'une entrée de Page Table avec la valeur
  des 3 bits de poid faible de \verb+data+.
\end{itemize}

\subsection*{Questions}

\begin{enumerate}
\item Quelle quantité au total de mémoire virtuelle est rendue
  accessible par notre cache ?

\item \`A quelles adresses (en mémoire virtuelle) est-il possible
  d'accéder aux traductions contenues par la Page Table ?

\item Si la CPT est pleine\footnote{Toutes les traductions possibles
    sont fa\^ites}, l'ajout d'une nouvelle entrée suppose la
  suppression d'une vieille entrée. Pour déterminer l'entrée du cache
  a retirer, écrivez une fonction implémentant un des algorithmes de
  remplacement d'entrées vu en cours (LRU, NFU ...). \footnote{Si vous
    séchez, vous pouvez utiliser la fonction rand\_1024()}

\item Écrivez la fonction
  \verb+vaddr_t cache_get_mapping(paddr_t phys)+. Cette fonction
  retourne l'adresse virtuelle d'une traduction vers \verb+phys+ si la
  traduction existe déjà, ou crée la traduction dans le cache le cas
  échéant.

\item Expliquez comment on peut fabriquer un espace d'adressage
  utilisateur \`a partir de zéro en utilisant la fonction
  \verb+cache_get_mapping()+ et une fonction
  \verb+paddr_t get_physical_page()+ qui alloue des pages de mémoire
  physique.
\end{enumerate}

