\section*{Exercice 4 : Copy-on-write (6 points)}

Le copy-on-write est une astuce d'optimisation tr\`es utilisée dans
les noyaux modernes dont le principe est le suivant :\\
\\
 lorsqu'on clone un espace d'adressage (par exemple dans le cas d'un appel système
\emph{fork}), les zones réservées en mémoire physique ne sont pas
dupliquées. Seules les correspondances (mappings) entre la mémoire
virtuelle et la mémoire physique sont recopiées.

Par la suite, c'est uniquement lors d'une écriture dans une zone
mémoire que le segment de mémoire physique est recopié (afin qu'il y
en ait un exemplaire par espace d'adressage).

Dans cet exercice, nous simplifions le problème en considérant
qu'\textbf{un espace d'adressage ne pourra être dupliqué qu'une unique
fois}.\\
\begin{description}
\item {\bf Implémentation du gestionnaire de page-fault}

\begin{enumerate}
\item Comment faut-il modifier les objets {\em o\_as}, {\em o\_segment} et
{\em o\_region} si l'on veut impl\'ementer le copy-on-write dans kaneton ?

\item Quels autres changements devrez-vous Vous indiquerez aussi les modifications à faire dans les opérations
existantes pour prendre en compte ou remplir les champs ajoutés.




\item Ecrivez le code du gestionnaire de page-fault. Vous pouvez employer
toutes les fonctions de l'interface kaneton. Votre code doit être {\bf indépendant
de l'architecture}.\\
\\
{\bf Note:} si votre code n\'ecessite une partie dépendante de
l'architecture (pour mettre-à-jour des TLB par exemple), vous
pr\'eciserez \textbf{sans l'implémenter} le comportement de ce code.

Le prototype du gestionnaire de page-fault est le suivant :

\function{page\_fault}{(i\_as asid, t\_vaddr address, t\_bool is\_write\_fault)}{}
\begin{itemize}
\item \emph{asid} est l'identifiant de l'espace d'adressage sur lequel
  s'est produit l'erreur
\item \emph{address} est l'adresse virtuelle ayant provoqué l'erreur
\item \emph{is\_write\_fault} indique si l'erreur est due à une tentative
  d'écriture à une adresse marquée en lecture seule.\\
\end{itemize}
\end{enumerate}


\item {\bf Implémentation sans limitations (bonus)}

\begin{enumerate}
\item En quoi le cas ou un espace d'adressage peut être dupliqué plusieurs
fois est-il plus complexe à gérer ?

\item Proposez les modifications pour gérer le copy-on-write quelque soit le
nombre de clonages de l'espace d'adressage effectué.
\end{enumerate}
\end{description}
