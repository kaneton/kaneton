%%
%% licence       kaneton licence
%%
%% project       kaneton
%%
%% file          /home/mycure/kaneton/view/lectures/development-environment/development-environment.tex
%%
%% created       julien quintard   [sun dec 18 18:39:23 2005]
%% updated       julien quintard   [tue jan 10 16:18:46 2006]
%%

%
% template
%

\input{../../template/lecture.tex}

%
% title
%

\title{Development Environment}

%
% authors
%

\author
{
  Julien~Quintard\inst{1}
}

%
% document
%

\begin{document}

%
% title frame
%

\begin{frame}
  \titlepage

  \begin{center}
    \logos
  \end{center}
\end{frame}

%
% outline frame
%

\begin{frame}
  \frametitle{Outline}
  \tableofcontents
\end{frame}

%
% overview
%

\section{Overview}

% 1)

\begin{frame}
  \frametitle{Introduction}

  From the previous years, a development environment was introduced.

  \nl

  The questions are:

  \begin{enumerate}[<+->]
    \item
      Why?
    \item
      What are the advantages and disadvantages of such a
      development environment?
    \item
      How did the other promotions do?
  \end{enumerate}
\end{frame}

% 2)

\begin{frame}
  \frametitle{Explanations}

  Over the years, the kaneton project evolved, starting with a very
  simple introduction to low-level programming and finally
  to microkernel development.

  \nl

  Going always further implies many modifications in the project
  including:

  \begin{itemize}[<+->]
    \item
      The courses given which now go from the Intel processor to
      the distributed operating system concepts.
    \item
      The assignments which always evolve to study advanced topics.
    \item
      The context because we now have to provide parts of the microkernel
      to avoid students a development from scratch.
    \item
      .. and so the prerequisites.
  \end{itemize}
\end{frame}

% 3)

\begin{frame}
  \frametitle{The Courses}

  The kaneton project now comes with four courses:

  \begin{enumerate}
    \item
      The design of the kaneton distributed operating system including
      the microkernel.
    \item
      The Intel processor.
    \item
      The kernel concepts.
    \item
      The distributed operating system concepts.
  \end{enumerate}
\end{frame}

% 4)

\begin{frame}
  \frametitle{The Assignments}

  During the year 2005, the students develop a poor microkernel
  from scratch with few functionalities, a driver and finally a baby
  file system.

  \nl

  We cannot ask the students of the year 2006 to develop the same project
  but to go further to study advanced topics like distributed algorithms.

  \nl

  So, we cannot ask the students to develop every parts of the microkernel
  because this takes much time and implies to not study advanced
  topics.
\end{frame}

% 5)

\begin{frame}
  \frametitle{The Context}

  Providing students parts of the microkernel is not enough.

  \nl

  Indeed, we decided to provide a complete development environment
  including:

  \begin{itemize}
    \item
      Makefiles.
    \item
      Shell scripts.
    \item
      Papers.
    \item
      Tools.
    \item
      .. everything you need to start microkernel development.
  \end{itemize}
\end{frame}

% 6)

\begin{frame}
  \frametitle{Why?}

  The remaining question is:

  \nl

  \textbf{Why providing such a development environment and not letting us
    develop one ourself?}

  \nl

  The answers simply are:

  \begin{itemize}
    \item
      Developing such a development environment takes much time and
      need experience.
    \item
      This development environment include very powerful features:
      multiusers cooperation, different operating systems etc..
    \item
      Finally, students will not be able to create such a complicated
      development tree so it is provided to not waste time.
  \end{itemize}
\end{frame}

% 7)

\begin{frame}
  \frametitle{The Prerequisites}

  The students starting the kaneton project should think that they
  will learn many many things during the year.

  \nl

  This year, we are trying to lead students to a distributed operating
  system.

  \nl

  This implies more concepts, algorithms and techniques to learn.

  \nl

  To do this we introduced more courses but the students will have
  to work hard to be able to success.
\end{frame}

% 8)

\begin{frame}[containsverbatim]
  \frametitle{Tree}

  \begin{center}

  \begin{verbatim}
    /
      cheat/
      check/
      core/
      doc/
      drivers/
      env/
      export/
      internship/
      libs/
      licences/
      programs/
      services/
      tools/
      view/
  \end{verbatim}

  \end{center}
\end{frame}

%
% env
%

\section{env}

% 1)

\begin{frame}
  \frametitle{Overview}

  The \textbf{env} directory contains the different development environments.

  \nl

  This directory is the heart of the kaneton development system.

  \nl

  Indeed, a user can develop the kaneton project on a Mac machine using
  cross compilation for Intel processors ('cause PowerPC processor)
  while another one is using a FreeBSD operating system on an Intel processor.

  \nl

  So, the development environment has to deal with these different operating
  systems and architectures just for the development.

  \nl

  The entire kaneton compiling system is based on two programs:
  \textbf{gmake} for the makefiles and \textbf{bash} for the shell scripts.

  \nl

  If an operating system has these two programs, it will be able to run
  and develop the kaneton microkernel.
\end{frame}

% 2)

\begin{frame}
  \frametitle{Our System}

  To do this, we decided to introduce an environment system.

  \nl

  Every time a user gets the kaneton development tarball, he first has to
  create his development environment given a couple machine and user.

  \nl

  Once the environment is installed, the user can develop, compile the kernel
  etc.. without problems because everything (makefiles, scripts etc..) use
  the binaries, variables etc.. for his environment.
\end{frame}

% 3)

\begin{frame}[containsverbatim]
  \frametitle{Tree}

  \begin{verbatim}
    env/
      .env.conf
      clean.sh
      critical.sh
      init.sh
      machines/
      users/
  \end{verbatim}
\end{frame}

% 4)

\begin{frame}
  \frametitle{critical.sh}

  The \textbf{critical.sh} shell script is used to set critical variables and
  functions for the next steps of kaneton development environment.

  \nl

  This script calls the specific \textbf{critical.sh} script for the given
  machine (explained later in this document).

\end{frame}

% 5)

\begin{frame}
  \frametitle{init.sh}

  The \textbf{init.sh} shell script is used to install the development
  environment.

  \nl

  This script calls the specific \textbf{init.sh} scripts of the given
  machine and user.

  \nl

  Finally the script installs some links and initialises the makefile
  dependencies.
\end{frame}

% 6)

\begin{frame}
  \frametitle{clean.sh}

  The \textbf{clean.sh} shell script just cleans the environment.

  \nl

  This shell script also calls the machine and user specific clean.sh scripts.
\end{frame}

% 7)

\begin{frame}
  \frametitle{.env.conf}

  This file is the main environment configuration file.

  \nl

  This file defines the directories, the scripts etc..

  \nl

  This file is always included first.
\end{frame}

% 8)

\begin{frame}[containsverbatim]
  \frametitle{Use}

  \begin{verbatim}
    $ make init
    [+] installing environment

    [+] your current configuration:
    [+]   user:                     julien.quintard
    [+]   machine:                  unix
    [+]   architecture:             ibm-pc.ia32-virtual
    [+]   multi-bootloader:         grub

    [...]

    $ make clean
    [+] cleaning environment

    [...]

    $
  \end{verbatim}
\end{frame}

%
% machines
%

\subsection{machines}

% 1)

\begin{frame}
  \frametitle{Overview}

  The \textbf{machines} directory, located in the \textbf{env} directory,
  contains the different machines.

  \nl

  A \textbf{machine} is a couple operating system, architecture.

  \nl

  More precisely a machine is composed of:

  \begin{itemize}[<+->]
    \item
      \textbf{an operating system}: on which the user will develop,
      use kaneton.
    \item
      \textbf{an architecture}: on which the operating system
      is running.
    \item
      \textbf{a target architecture}: which is the architecture used
      to compile the kaneton microkernel.
  \end{itemize}
\end{frame}

% 2)

\begin{frame}[containsverbatim]
  \frametitle{Tree}

  \begin{verbatim}
    machines/
      unix/
        clean.sh
        critical.sh
        init.sh
        machine.conf
        machine.mk
        machine.sh
      macos-powerpc.sparc64/
    users/
  \end{verbatim}

  The configuration system uses the shell variable \$KANETON\_MACHINE to
  use the good scripts and files in \textbf{env/machines/\$KANETON\_MACHINE/}.

  \nl

  But to install the machine environment, \textbf{bash} is used. And its
  path is specified in the machine environment. So it is possible to override
  default path to bash with shell variable \textbf{\$KANETON\_SHELL} (default
  is \textbf{/bin/bash}).
\end{frame}

% 3)

\begin{frame}
  \frametitle{critical.sh}

  This is the very first called script. It creates two files: \textbf{.env.sh}
  and \textbf{.env.mk}.

  \nl

  These files contains development environment's high level functions for using
  in makefiles and other scripts. With this feature, developers are able to
  create makefiles and scripts without calling any external program.

  \nl

  For example, you will no longer write things like
  \textbf{sed -r 's/arch/ia32/g'} in you shell scripts, but instead you will
  use the \textbf{substitute} function to which you can pass
  machine-independent options. Above line becomes
  \textbf{substitute arch ia32 all} (which is a bit more elegant).
\end{frame}

% 4)

\begin{frame}
  \frametitle{init.sh}

  This is the machine-dependent init script.

  \nl

  This script can be used by the machine to, for example, install some
  architecture links or to detect the binaries used by this machine.
\end{frame}

% 5)

\begin{frame}
  \frametitle{clean.sh}

  This script is called by the clean.sh script of the \textbf{env}
  directory.

  \nl

  This script just cleans machine-dependent stuff.
\end{frame}

% 6)

\begin{frame}
  \frametitle{machine.conf}

  This file is the main machine-specific configuration file.

  \nl

  This file defines the binaries used by this machine.

  \nl

  This file will always be included after the \textbf{.env.conf}
  file so a machine is able to redefine kaneton variables if needed.
\end{frame}

% 7)

\begin{frame}
  \frametitle{machine.mk}

  The \textbf{machine.mk} makefile dependency defines machine-dependent
  makefile functions.

  \nl

  Indeed, every makefile is composed of calls to special routines
  which are implemented by the makefile dependency depending on the
  machine: operating system plus architecture source and destination.

  \nl

  The kaneton compilation system uses a very special gmake feature:
  the makefile \textbf{call} function.

  \nl

  Each machine has to provide a set of make functions to be able to run
  the kaneton compilation system.
\end{frame}

% 8)

\begin{frame}
  \frametitle{machine.sh}

  This file contains every shell functions used by the machine.

  \nl

  In the same way than makefiles, the kaneton shell scripts call
  machine-specific routines.

  \nl

  So every machine has to provide these routines to be able to run
  kaneton shell scripts.
\end{frame}

%
% users
%

\subsection{users}

% 1)

\begin{frame}
  \frametitle{Overview}

  The \textbf{users} directory contains user variables used to parameterise:

  \begin{itemize}
    \item
      the development environment: makefiles, scripts etc..
    \item
      the kernel
  \end{itemize}

  \nl

  This configuration system is very interesting coupled with versionning
  systems.

  \nl

  Indeed, you can develop using special compilation flags, specific kernel
  configuration without conflicts with other developers.
\end{frame}

% 2)

\begin{frame}[containsverbatim]
  \frametitle{Tree}

  \begin{verbatim}
    users/
      julien.quintard/
        conf.c
        conf.h
        kaneton.conf
        modules.conf
        user.conf
        user.mk
        user.sh
      check/
      release/
  \end{verbatim}

  This configuration system uses the shell variable \$KANETON\_USER to find
  the main configuration file: \textbf{env/users/\$KANETON\_USER/user.conf}.
\end{frame}

% 3)

\begin{frame}
  \frametitle{conf.c}

  This file is not used yet.
\end{frame}

% 4)

\begin{frame}
  \frametitle{conf.h}

  This file contains macros to configure the kernel:

  \begin{itemize}
    \item
      \textbf{CONF\_DEBUG}
    \item
      etc..
  \end{itemize}

  \nl

  This file is included by the kernel code.
\end{frame}

% 5)

\begin{frame}
  \frametitle{kaneton.conf}

  This configuration file is used to pass arguments at the runtime to the
  servers.

  \nl

  This file is also used to configure kernel and servers input variables.
\end{frame}

% 6)

\begin{frame}
  \frametitle{modules.conf}

  This file contains the list of the modules to be loaded by the
  multi-bootloader.

  \nl

  These modules will be passed to the kernel at the boot time.

  \nl

  Be careful, a module here is not a module in the Linux or BSD terms.

  \nl

  A module is simply a file to load.

  \nl

  Moreover, only the files present in these files will be compiled by
  the kaneton compiling system.
\end{frame}

% 7)

\begin{frame}
  \frametitle{user.conf}

  Finally the main configuration file contains the configuration
  variables for the development environment.

  \nl

  This file uses the syntax of the make files.

  \nl

  Every variable defined in this file will be used by the makefiles
  and the scripts.
\end{frame}

% 8)

\begin{frame}
  \frametitle{user.mk}

  This file defines user-specific make stuff.

  \nl

  This file is included by the kaneton makefiles.
\end{frame}

% 9)

\begin{frame}
  \frametitle{user.sh}

  This file defines user-specific shell variables or shell functions.

  \nl

  This file will always be included by the kaneton shell scripts.
\end{frame}

%
% tools
%

\section{tools}

% 1)

\begin{frame}
  \frametitle{Overview}

  The \textbf{tools} directory contains programs, scripts, special
  files used by the kaneton project.

  \nl

  For example a script to initialise and install modules on a grub
  bootloader boot device is provided in the subdirectory
  \textit{mbl/grub/}.
\end{frame}

% 2)

\begin{frame}[containsverbatim]
  \frametitle{Tree}

  \begin{verbatim}
    tools/
      mbl/
        grub/
        lilo/
      proto/
        mkp.py
  \end{verbatim}
\end{frame}

% 3)

\begin{frame}[containsverbatim]
  \frametitle{Use}

  \begin{verbatim}
    $ make build
    [+] initialising boot system

    [+] boot system initialised successfully
    $ make install
    [+] initialising boot system

    [+] /tmp/menu.lst
    [+] core/bootloader/bootloader
    [+] core/kaneton/kaneton
    [+] env/.kaneton.conf
    [+] drivers/cons/cons
    [+] services/dsh/dsh

    [+] boot system initialised successfully
    $
  \end{verbatim}
\end{frame}

% 4)

\begin{frame}[containsverbatim]
  \frametitle{Prototypes}

  The compilation system permits to generate the prototypes in a very easy
  and elegant way.

  \begin{verbatim}
    $ make proto
    [PROTOTYPES]            libdata.h
    [PROTOTYPES]            libstring.h
    [PROTOTYPES]            libsys.h
    [PROTOTYPES]            bootloader.h
    [PROTOTYPES]            ia32.h
    [PROTOTYPES]            kaneton.h
    [PROTOTYPES]            as.h
    [PROTOTYPES]            conf.h
    [PROTOTYPES]            serial.h

    [...]

    $
  \end{verbatim}
\end{frame}

% 5)

\begin{frame}[containsverbatim]
  \frametitle{Explanations}

  This system is based on tags in the header files which specify
  from which files to extract prototypes.

  \nl

  The tags are of the form:

  \begin{verbatim}
    /*
     * ---------- prototypes -------------------------------------------------
     *
     *      ../../kaneton/set/set.c
     *      ../../kaneton/set/set_array.c
     *      ../../kaneton/set/set_ll.c
     *      ../../kaneton/set/set_bpt.c
     */
  \end{verbatim}
\end{frame}

% 5)

\begin{frame}[containsverbatim]
  \frametitle{Dependencies}

  The compilation system uses full dependencies between files.

  \nl

  To regenerate the dependencies, for example when adding a
  \textit{\#include} c-preprocessor directive in a source file:

  \begin{verbatim}
    $ make dep
    [REMOVE]                .makefile.mk
    [DEPENDENCIES]          dump.c
    [DEPENDENCIES]          alloc.c
    [DEPENDENCIES]          sum2.c

    [...]

    $
  \end{verbatim}
\end{frame}

%
% libs
%

\section{libs}

% 1)

\begin{frame}
  \frametitle{Overview}

  The \textbf{libs} directory contains the libraries used by the kaneton
  project like:

  \begin{itemize}
    \item
      klibc
    \item
      crt
    \item
      libposix
    \item
      etc..
  \end{itemize}
\end{frame}

%
% core
%

\section{core}

% 1)

\begin{frame}
  \frametitle{Overview}

  The \textbf{core} directory contains the source code for the microkernel
  including the bootstrap, the bootloader and the kernel itsef.

  \nl

  Each part contains an \textbf{arch} directory used for architecture
  dependent soure code.
\end{frame}

% 2)

\begin{frame}[containsverbatim]
  \frametitle{Tree}

  \begin{verbatim}
    core/
      bootstrap/
        arch/
          ibm-pc.ia32-virtual/   <---;
          machdep -------------------+
      bootloader/
        arch/
      kaneton/
        arch/
        as/
        conf/
        debug/
        id/
        segment/
        set/
        stats/
  \end{verbatim}
\end{frame}

%
% drivers
%

\section{drivers}

% 1)

\begin{frame}
  \frametitle{Overview}

  The \textbf{drivers} directory contains the drivers of the kaneton
  microkernel.

  \nl

  A driver, in the kaneton terms, is a microkernel server which is allowed
  to communicate with hardware devices.
\end{frame}

% 2)

\begin{frame}[containsverbatim]
  \frametitle{Tree}

  \begin{verbatim}
    drivers/
      cons/
        Makefile
        cons.c
      dma/
      kbd/
      ide/
  \end{verbatim}
\end{frame}

%
% services
%

\section{services}

% 1)

\begin{frame}
  \frametitle{Overview}

  The \textbf{services} directory contains the services of the kaneton
  microkernel.

  \nl

  A service, in the kaneton terms, in simply a server which does not
  communicate with the hardware.
\end{frame}

% 2)

\begin{frame}[containsverbatim]
  \frametitle{Tree}

  \begin{verbatim}
    services/
      dsh/
      mod/
        Makefile
        mod.c
        modfs.c
  \end{verbatim}
\end{frame}

%
% programs
%

\section{programs}

% 1)

\begin{frame}
  \frametitle{Overview}

  The \textbf{programs} directory contains the sources of common
  programs.

  \nl

  A program in the kaneton terms is just a non-privilegied
  process.
\end{frame}

% 2)

\begin{frame}[containsverbatim]
  \frametitle{Tree}

  \begin{verbatim}
    programs/
      ls/
      wc/
      cat/
      mount/
      umount/
      gcc/
      emacs/
  \end{verbatim}
\end{frame}

%
% export
%

\section{export}

% 1)

\begin{frame}
  \frametitle{Overview}

  The \textbf{export} directory is used to create kaneton distribution.

  \nl

  This feature is especially used by the maintainers of the kaneton
  project which create very special kaneton distribution for
  the students.
\end{frame}

% 2)

\begin{frame}[containsverbatim]
  \frametitle{Use}

  The only way to export kaneton is to do like this:

  \begin{verbatim}
    $ make export
    [!] usage: export.sh [stage]

    available stages: k0 k1 k2 k3 k4 k5 k6 k7 k8 k9 kn dist
    $ make export-k3
  \end{verbatim}

  \begin{itemize}
    \item
      \textbf{k[0-9]}: create a special kaneton version for the k[0-9]
      subproject.
    \item
      \textbf{kn}: create an entire kaneton version for the lastest
      subproject.
    \item
      \textbf{dist}: create an entire backup of the kaneton development
      project.
  \end{itemize}
\end{frame}

%
% view
%

\section{view}

% 1)

\begin{frame}
  \frametitle{Overview}

  The \textbf{view} directory contains the papers and lectures
  in relation with the kaneton project.

  \nl

  We prefered set the papers directly into the tarball so every student
  can easily read them.
\end{frame}

% 2)

\begin{frame}[containsverbatim]
  \frametitle{Tree}

  \begin{verbatim}
    view/
      lectures/
        kernels/
        inline-assembly/
        c-preprocessor/
        arch-ia32/
        prerequisites/
      papers/
        assignments/
        design/
        kaneton/
        seminar/
  \end{verbatim}
\end{frame}

% 3)

\begin{frame}[containsverbatim]
  \frametitle{Use}

  \begin{verbatim}
    $ make view
    [+] papers:

    [+]   assignments
    [+]   design
    [+]   arch-ia32
    [+]   c-preprocessor
    [+]   prerequisites
    [+]   inline-assembly
    [+]   kernels
    [+]   development-environment

    [!] usage: view.sh [paper]
    $ make view-design
  \end{verbatim}
\end{frame}

%
% doc
%

\section{doc}

% 1)

\begin{frame}
  \frametitle{Overview}

  The \textbf{doc} directory contains every document useful for
  the development of the kaneton project.

  \nl

  This directory will theorically contain documents on the different
  architectures, documents on some hardware devices like ide, usb etc..
\end{frame}

\end{document}
